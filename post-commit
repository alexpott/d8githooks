#!/bin/bash
command_exists () {
    type "$1" &> /dev/null ;
}

REV=`git rev-parse --verify HEAD | head -c7`
BRANCH=`git rev-parse --symbolic --abbrev-ref HEAD`
TEXT="Committed <a href=\"http://cgit.drupalcode.org/drupal/commit/?id=$REV\">$REV</a> and pushed to $BRANCH. Thanks!"
if command_exists pbcopy ; then
  echo $TEXT | pbcopy
fi
if command_exists cowsay ; then
  # Bug in cowsay's text wrapping :(
  cowsay -W 200 $TEXT
else
  echo "$TEXT\n"
fi

# Need to build and commit the JS
FILES=`git diff-tree --no-commit-id --name-only -r ${REV}`
HAS_JS=0
echo ${FILES};
for FILE in $FILES; do
    echo "$FILE" | grep -q "\.js$"
    TEST=$?
    if [ -a $FILE -a "$TEST" == "0" ] ; then
        HAS_JS=1
        break
    fi
done

if [ $HAS_JS == 1 ] ; then
  TOP_LEVEL=$(git rev-parse --show-toplevel);
  cd "$TOP_LEVEL/core"
  yarn run build:js
  # todo add build files and commit them.
  cd "$TOP_LEVEL"
fi
